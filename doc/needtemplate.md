# 产品需求文档 (PRD) - [项目名称]

## 1. 修订历史

| 版本号 | 修订日期   | 修订内容 | 修订人 |
| ------ | ---------- | -------- | ------ |
| V1.0   | YYYY-MM-DD | 初始版本 | XXX    |
|        |            |          |        |

## 2. 引言

### 2.1. 项目背景与目标

- (简述项目发起的背景、要解决的核心问题)
- (明确、可衡量的项目目标，例如：为企业用户提供安全、本地化的知识库问答服务，将信息检索效率提升 X%)
- (项目的预期商业价值或用户价值)

### 2.2. 项目范围

- **包含范围 (In Scope):** (清晰列出本次迭代或版本包含的核心功能模块)
  - 例如：用户认证、知识库管理 (上传 txt/pdf, 删除)、助手创建/编辑、基于 RAG 的问答、会话管理...
- **排除范围 (Out of Scope):** (明确列出本次不包含的功能，避免范围蔓延)
  - 例如：多格式文件支持 (docx, md)、知识库在线编辑、模型微调、多租户管理...

### 2.3. 目标用户

- (描述主要的目标用户群体及其特征)
  - **To B 用户:** (例如：注重数据隐私和本地化部署的中小型企业 IT 部门、知识管理部门)
  - **To C 用户:** (例如：需要构建个人知识体系、提升学习/工作效率的学生、研究人员、开发者)

### 2.4. 术语定义

- **RAG (Retrieval-Augmented Generation):** 检索增强生成，一种结合信息检索和大型语言模型生成能力的技术。
- **知识库 (Knowledge Base):** 用户上传的文档集合，用于 RAG 检索。
- **向量化 (Vectorization):** 将文本转换为数值向量的过程，用于相似度计算和检索。
- **助手 (Assistant):** 用户创建的、具有特定配置（如 Prompt, 关联知识库）的 AI 实体。
- **会话 (Session):** 用户与特定助手进行的一系列问答交互。
- **(根据项目需要补充其他术语)**

## 3. 用户故事 / 用例 (可选，可与功能需求合并)

- (选择一种或结合使用)

### 3.1. 用户故事 (User Stories)

- **格式:** 作为一个 `<用户角色>`, 我想要 `<完成某事>`, 以便 `<获得某种价值>`。
- **示例:**
  - 作为一个 `企业管理员`, 我想要 `上传公司内部 PDF 格式的规章制度到知识库`, 以便 `员工可以通过问答系统快速查询相关规定`。
  - 作为一个 `个人用户`, 我想要 `创建一个自定义名称和提示词的助手`, 以便 `让它扮演特定的角色来回答我的问题`。
  - 作为一个 `普通用户`, 我想要 `在会话中输入问题并选择关联的知识库`, 以便 `获得基于特定文档内容的回答`。

### 3.2. 用例 (Use Cases)

- (为关键交互流程创建用例)
- **示例: 用户进行知识库问答**
  - **用例名称:** 用户进行知识库问答
  - **参与者:** 注册用户
  - **前置条件:** 用户已登录，已创建至少一个助手并关联了知识库，已进入与该助手的会话页面。
  - **触发条件:** 用户在会话页面输入问题并点击发送。
  - **基本流程:**
    1.  系统接收用户输入的问题。
    2.  系统使用 RAG 技术，在助手关联的知识库中检索与问题相关的文本片段。
    3.  系统将检索到的文本片段和用户问题，结合助手的 Prompt，提交给选定的大语言模型 (LLM)。
    4.  LLM 生成答案。
    5.  系统将 LLM 生成的答案显示在会话界面的聊天框中。
    6.  系统保存本次问答记录到当前会话历史。
  - **替代流程/异常处理:**
    - 如果在知识库中未检索到相关内容，如何处理？(提示用户/仅用 LLM 回答)
    - LLM 调用失败或超时，如何处理？(提示用户错误)
    - 用户输入为空或无效，如何处理？
  - **后置条件:** 用户看到问题的答案，问答记录被保存。

## 4. 功能需求 (Functional Requirements)

- (详细描述每个功能模块)

### 4.1. 用户认证与管理

- **FR-AUTH-001:** 用户注册 (需要哪些信息？密码策略？)
- **FR-AUTH-002:** 用户登录 (认证方式？)
- **FR-AUTH-003:** (如果需要) 用户信息修改

### 4.2. 知识库管理

- **FR-KB-001:** 创建知识库 (命名规则？)
- **FR-KB-002:** 上传文档到知识库
  - 支持的文件格式：(例如：txt, pdf)
  - 文件大小限制：
  - 上传后的处理：(显示处理进度？如何进行向量化？存储在哪里？)
- **FR-KB-003:** 查看知识库列表 (显示哪些信息？)
- **FR-KB-004:** 查看知识库内文档列表
- **FR-KB-005:** 删除知识库 (删除时是否需要确认？关联数据如何处理？)
- **FR-KB-006:** 删除知识库内指定文档
- **(需要补充编辑功能吗？例如重命名知识库？)**

### 4.3. 助手管理

- **FR-ASST-001:** 创建助手

  - **输入:** 前端需提供 `username` (来自登录状态)。可选择性提供 `title`, `prompt`, `knowledge_Id`。
  - **处理:** 如果未提供 `title`, `prompt`, 则使用默认值。
  - **必填/可选字段:** `username` (必填), `title` (可选), `prompt` (可选), `knowledge_Id` (可选)
  - **默认值:** `title`: "新助手", `prompt`: "你是一个 AI 助手，请根据用户的问题给出回答。"
  - **输出:** 返回创建的助手对象。
  - **约束:** 一个用户可以创建多个助手。

- **FR-ASST-002:** 查看用户拥有的助手列表

  - **输入:** `username` (来自 Query 参数)。
  - **处理:** 查询该 `username` 下的所有助手，并按 `created_at` **升序** 排序 (最新的在后)。
  - **输出:** 返回包含助手所有字段信息的列表 (`id`, `title`, `username`, `prompt`, `knowledge_Id`, `created_at`)。

- **FR-ASST-003:** 编辑助手

  - **输入:** `assistant_id` (来自 Path 参数), 请求体包含 `title`, `prompt`, `knowledge_Id` (不允许修改 `username`)。
  - **处理:** 查找指定 `assistant_id` 的助手，更新其 `title`, `prompt`, `knowledge_Id` 字段。
  - **输出:** 返回更新后的助手对象。
  - **约束:** 仅允许修改 `title`, `prompt`, `knowledge_Id`。

- **FR-ASST-004:** 删除助手
  - **输入:** `assistant_id` (来自 Query 参数)。
  - **交互:** 前端需弹出确认框，提示用户"确定要删除助手 [助手名称] 及其所有会话记录吗？"
  - **处理:**
    1.  查找指定 `assistant_id` 的助手。
    2.  查找所有关联的 `Session` (通过 `Session.assistant_id == assistant_id`)。
    3.  遍历关联的 `Session`，对每个 `session_id` 调用 `ChatSev.clear_history` 清除聊天记录，然后删除 `Session` 文档。
    4.  删除 `Assistant` 文档。
  - **输出:** 返回成功消息。

### 4.4. 会话管理

- **FR-SESS-001:** 创建新会话

  - **输入:** 请求体包含 `username` (来自登录状态), `assistant_id`。可选择性提供 `title`。
  - **处理:** 使用提供的字段和默认值创建新的 `Session` 文档。
  - **必填/可选字段:** `username` (必填), `assistant_id` (必填), `title` (可选)。
  - **默认值:** `title`: "新会话"。
  - **输出:** 返回创建的会话对象。
  - **约束:** 一个用户可以拥有多个会话，每个会话必须关联一个助手。

- **FR-SESS-002:** 查看用户会话列表

  - **输入:** `username` (来自 Query 参数)。
  - **处理:** 查询该 `username` 下的所有会话，并按 `updated_at` **降序** 排序 (最近更新的在前)。
  - **输出:** 返回会话列表，包含 `id`, `title`, `username`, `assistant_id`, `created_at`, `updated_at` 字段。
  - **前端展示:** 前端界面会将此列表按 `assistant_id` 分组显示。列表项主要显示 `title` 和 `updated_at` (用于计算相对时间，如"几天前")。

- **FR-SESS-03:** 修改会话标题

  - **输入:** `session_id` (来自 Path 参数), `title` (来自 Query 参数或请求体)。
  - **处理:** 查找指定 `session_id` 的会话，更新其 `title` 和 `updated_at` 字段。
  - **输出:** 返回更新后的会话对象。

- **FR-SESS-004:** 删除会话

  - **输入:** `session_id` (来自 Path 参数)。
  - **交互:** 前端需弹出确认框，提示用户"确定要删除此会话及其所有历史记录吗？"
  - **处理:**
    1.  查找指定 `session_id` 的会话。
    2.  调用 `ChatSev.clear_history` 清除该 `session_id` 的聊天记录。
    3.  删除 `Session` 文档。
  - **输出:** 返回成功消息。

- **FR-SESS-005:** 查看会话历史消息
  - **API:** 使用 `GET /session/{session_id}/history` 端点。
  - **输入:** `session_id` (来自 Path 参数), `page` (Query 参数, 默认为 1), `page_size` (Query 参数, 默认为 10)。
  - **处理:** 服务端根据 `session_id` 查询 `ChatHistoryMessage` 集合，按 `_id` (或时间戳) 降序排列，进行分页。
  - **输出:** 返回包含分页信息 (`page`, `size`, `total_pages`, `total_items`) 和当前页消息列表 (`items`) 的 JSON 对象。`items` 列表中的每个消息包含 `type` ('human' 或 'ai') 和 `content`。
  - **前端展示:** 聊天界面根据 `type` 区分用户和 AI 消息（例如左右气泡），显示 `content`。暂不需要显示时间戳。

### 4.5. RAG 问答流程

- **FR-RAG-001:** 用户在会话中提问 (输入框、发送按钮)
- **FR-RAG-002:** 选择/切换大语言模型 (需要支持哪些模型？如何配置？)
- **FR-RAG-003:** 选择/切换知识库 (在助手已关联的知识库中切换，还是可以临时选择其他？)
- **FR-RAG-004:** RAG 核心逻辑
  - 问题向量化
  - 知识库向量检索 (使用哪种算法？Top-K 设置？)
  - Prompt 构建 (如何组织用户问题、检索到的上下文、助手原始 Prompt？)
  - LLM 调用 (API 接口？参数配置 - 如 temperature, max_tokens)
  - 答案解析与回显
- **FR-RAG-005:** (可选) 联网搜索集成 (如何触发？如何将搜索结果融入 RAG？)
- **FR-RAG-006:** (可选) 快捷添加提示词功能
- **FR-RAG-007:** 问答历史记录存储

### 4.6. 系统设置 (可选)

- **FR-SET-001:** LLM 模型参数调整 (例如：Temperature, Max Context Tokens)
- **FR-SET-002:** (其他可配置项)

## 5. 非功能性需求 (Non-Functional Requirements)

### 5.1. 性能需求

- **NFR-PERF-001:** 问答平均响应时间 < X 秒 (在 Y 并发用户下)
- **NFR-PERF-002:** 文件上传处理时间 < Z 秒 (针对 M 大小的文件)
- **NFR-PERF-003:** 系统支持最大并发用户数 N

### 5.2. 安全性需求

- **NFR-SEC-001:** 用户密码需加密存储。
- **NFR-SEC-002:** 防止常见的 Web 攻击 (XSS, CSRF, SQL 注入 - 虽然我们用 NoSQL，但也要考虑类似注入风险)。
- **NFR-SEC-003:** 本地部署时，确保数据不离开用户环境。
- **NFR-SEC-004:** API 接口访问权限控制。

### 5.3. 可用性需求

- **NFR-USAB-001:** 主要操作流程应直观易懂，新用户能在 5 分钟内完成一次知识库问答。
- **NFR-USAB-002:** 界面风格简洁统一。
- **NFR-USAB-003:** 提供必要的操作提示和错误反馈信息。

### 5.4. 可靠性需求

- **NFR-REL-001:** 系统 7x24 小时可用性 > 99.X%。
- **NFR-REL-002:** 关键数据 (用户信息、知识库、会话) 应有备份或恢复机制。
- **NFR-REL-003:** 妥善处理 LLM 或向量数据库服务不可用的情况。

### 5.5. 可维护性需求

- **NFR-MAIN-001:** 代码遵循 PEP8 规范，关键逻辑有清晰注释。
- **NFR-MAIN-002:** 模块化设计，降低耦合度。
- **NFR-MAIN-003:** 提供必要的日志记录，方便问题排查。

### 5.6. 可扩展性需求

- **NFR-EXT-001:** 易于未来增加新的 LLM 支持。
- **NFR-EXT-002:** 易于未来支持新的文件格式。
- **NFR-EXT-003:** 易于未来增加新的功能模块。

## 6. 界面与交互设计 (可选)

- (可以文字描述关键界面的布局和交互逻辑)
- (或者在此引用外部的线框图、原型设计链接或文件)
  - 例如：登录/注册页面、主界面布局 (知识库/助手/会话列表)、会话页面布局...

## 7. 发布标准 (Release Criteria)

- (定义产品达到什么标准才能发布)
- 所有 P0、P1 级别的 Bug 已修复。
- 核心功能 (注册、登录、知识库上传、助手创建、RAG 问答、会话管理) 通过测试。
- 性能和安全性达到最低要求。
- 必要的文档（如用户手册、部署指南）已完成。

## 8. 未来考虑 / 路线图 (Future Considerations / Roadmap)

- (列出当前版本之后可能的功能增强或发展方向)
- 支持更多文件格式 (docx, markdown...)
- 知识库增量更新
- 模型微调功能
- 更精细的权限管理
- ...

## 9. 开放性问题 (Open Issues)

- (记录当前需求中尚未明确或需要进一步讨论的问题)
- 知识库文档的去重策略？
- RAG 检索不到内容时的具体交互方式？
- B 端部署的具体环境要求？
- ...
